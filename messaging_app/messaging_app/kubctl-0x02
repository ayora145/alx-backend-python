#!/bin/bash

set -e

echo "ğŸš€ Starting Blue-Green Deployment..."

# Deploy Blue version (current)
echo "ğŸ“˜ Deploying Blue version..."
kubectl apply -f blue_deployment.yaml
kubectl apply -f kubeservice.yaml

# Wait for Blue deployment to be ready
echo "â³ Waiting for Blue deployment to be ready..."
kubectl rollout status deployment/messaging-app-blue --timeout=300s

# Deploy Green version (new)
echo "ğŸŸ¢ Deploying Green version..."
kubectl apply -f green_deployment.yaml

# Wait for Green deployment to be ready
echo "â³ Waiting for Green deployment to be ready..."
kubectl rollout status deployment/messaging-app-green --timeout=300s

# Check Green deployment logs for errors
echo "ğŸ” Checking Green deployment logs..."
kubectl logs -l app=messaging-app,version=green --tail=50

# Test Green deployment health
echo "ğŸ¥ Testing Green deployment health..."
GREEN_POD=$(kubectl get pods -l app=messaging-app,version=green -o jsonpath='{.items[0].metadata.name}')
kubectl exec $GREEN_POD -- curl -f http://localhost:8000/health/ || echo "âš ï¸  Health check failed"

# Switch traffic to Green
echo "ğŸ”„ Switching traffic to Green version..."
kubectl patch service messaging-app-service -p '{"spec":{"selector":{"version":"green"}}}'

echo "âœ… Blue-Green deployment completed!"
echo "ğŸ” Checking final service status..."
kubectl get services
kubectl get deployments