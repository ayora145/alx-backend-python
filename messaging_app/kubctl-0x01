#!/bin/bash
# Script: kubctl-0x01
# Purpose: Scale Django deployment, verify pods, perform load testing, and monitor resources

set -e  # Exit immediately if a command fails

DEPLOYMENT_NAME="django-messaging-deployment"
SERVICE_NAME="django-messaging-service"
NAMESPACE="default"

echo "ğŸš€ Scaling Django app to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3 -n $NAMESPACE

echo "âœ… Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE

echo "ğŸ“‹ Verifying running pods..."
kubectl get pods -n $NAMESPACE

echo "ğŸŒ Fetching service URL..."
NODE_PORT=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[0].address}')
URL="http://$NODE_IP:$NODE_PORT"

echo "ğŸ” Testing load on the scaled app using wrk..."
wrk -t4 -c100 -d30s $URL

echo "ğŸ“Š Monitoring resource usage (pods and nodes)..."
kubectl top pods -n $NAMESPACE
kubectl top nodes

echo "âœ… Done! Your Django app has been scaled and tested successfully."

